{% extends "base.html" %}

{% block title %}Dashboard - AirBind{% endblock %}

{% block content %}

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <h4 class="mb-3">Upcoming Events</h4>

        {% if events %}
        {% for event in events %}
        <div class="card mb-3 shadow-sm">
            <div class="row g-0">
                <div class="col-md-4">
                    {% if event.image %}
                    <div class="d-flex align-items-center justify-content-center"
                        style="height: 200px; background: #f8f9fa; overflow: hidden;">
                        <img src="{{ url_for('serve_event_image', filename=event.image) }}" alt="{{ event.name }}"
                            style="max-height: 100%; width: auto; object-fit: contain;">
                    </div>
                    {% else %}
                    <div class="bg-secondary d-flex align-items-center justify-content-center text-white"
                        style="height: 200px;">
                        No Image
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title">{{ event.name }}</h5>
                            <span class="badge bg-success">{{ event.commission_percent }}% Comm.</span>
                        </div>
                        <p class="card-text text-muted mb-2">
                            <small>{{ event.date.strftime('%d %b %Y') }} at {{ event.time.strftime('%I:%M %p') }} | {{
                                event.city }}</small>
                        </p>
                        <p class="card-text">{{ event.description[:150] }}...</p>

                        <div class="d-flex gap-2">
                            {% if event.is_active %}
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#addOrderModal{{ event.id }}" onclick="loadTickets({{ event.id }})">
                                Book Now
                            </button>
                            {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>
                                Booking Closed
                            </button>
                            {% endif %}
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#viewEventModal{{ event.id }}">
                                Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        {% include 'includes/event_modals.html' %}

        {% endfor %}
        {% else %}
        <div class="alert alert-info">No upcoming events found.</div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4 mt-5">
        <div class="row mb-4">
            <div class="col-6">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h6 class="text-muted">Sales</h6>
                        <h3>₹{{ "%.0f"|format(total_sales) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h6 class="text-muted">Pending Commission</h6>
                        <h3>₹{{ "%.0f"|format(pending_commission) }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Recent Orders
            </div>
            <ul class="list-group list-group-flush">
                {% if orders %}
                {% for order in orders[:5] %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <strong>{{ order.event.name }}</strong>
                        <span
                            class="badge bg-{{ 'success' if order.status == 'completed' else 'warning' if order.status == 'pending' else 'danger' }}">
                            {{ order.status }}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mt-1">
                        <span>{{ order.client_name }}</span>
                        <span>₹{{ order.total_amount }}</span>
                    </div>
                    {% if order.status == 'completed' and not order.commission %}
                    <form method="POST" action="/user/commission/request" class="mt-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <button type="submit" class="btn btn-success btn-sm w-100 py-0">Request Commission</button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
                {% else %}
                <li class="list-group-item text-muted text-center">No orders yet</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<script>
    const ticketData = {};

    function loadTickets(eventId) {
        const select = document.getElementById(`ticketSelect${eventId}`);
        select.innerHTML = '<option value="">Loading tickets...</option>';

        fetch(`/api/event/${eventId}/tickets`)
            .then(response => response.json())
            .then(tickets => {
                ticketData[eventId] = tickets;
                select.innerHTML = '<option value="">Select Ticket Category</option>';

                if (tickets.length === 0) {
                    select.innerHTML = '<option value="">No tickets available</option>';
                    return;
                }

                tickets.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = ticket.id;
                    option.textContent = `${ticket.category} - ₹${ticket.price}`;
                    option.dataset.price = ticket.price;
                    option.dataset.available = ticket.available_quantity;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                select.innerHTML = '<option value="">Error loading tickets</option>';
            });
    }

    function updateTicketInfo(eventId) {
        const select = document.getElementById(`ticketSelect${eventId}`);
        const selectedOption = select.options[select.selectedIndex];
        const quantityInput = document.getElementById(`quantity${eventId}`);
        const maxQtySpan = document.getElementById(`maxQty${eventId}`);

        if (selectedOption.value) {
            const available = selectedOption.dataset.available;
            quantityInput.max = available;
            quantityInput.value = 1;
            calculateTotal(eventId);
        } else {
            quantityInput.max = '';
            document.getElementById(`totalAmount${eventId}`).textContent = '₹0.00';
        }
    }

    function calculateTotal(eventId) {
        const select = document.getElementById(`ticketSelect${eventId}`);
        const selectedOption = select.options[select.selectedIndex];
        const quantity = parseInt(document.getElementById(`quantity${eventId}`).value) || 0;

        if (selectedOption.value && quantity > 0) {
            const price = parseFloat(selectedOption.dataset.price);
            const total = price * quantity;
            document.getElementById(`totalAmount${eventId}`).textContent = `₹${total.toFixed(2)}`;
            document.getElementById(`totalAmountHidden${eventId}`).value = total.toFixed(2);
        } else {
            document.getElementById(`totalAmount${eventId}`).textContent = '₹0.00';
            document.getElementById(`totalAmountHidden${eventId}`).value = '';
        }
    }

    function copyPromoText(button) {
        const text = button.getAttribute('data-promo-text');
        navigator.clipboard.writeText(text)
            .then(() => alert('Promotional text copied!'))
            .catch(err => console.error('Failed to copy:', err));
    }
</script>
{% endblock %}
